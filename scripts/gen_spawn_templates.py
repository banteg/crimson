from __future__ import annotations

import sys
from pathlib import Path


DOC_PATH = Path("docs/structs/creature.md")

START_MARKER = "<!-- spawn-templates:start -->"
END_MARKER = "<!-- spawn-templates:end -->"


def _repo_import() -> None:
    # Add `src/` to sys.path so we can import `crimson.*` from the repo root.
    repo_root = Path(__file__).resolve().parents[1]
    sys.path.insert(0, str(repo_root / "src"))


def _format_flags(flags: object | None) -> str:
    if flags is None:
        return ""
    # flags is an IntFlag; render as a single hex value (this matches existing docs style).
    return f"0x{int(flags):x}"


def _replace_block(text: str, replacement: str) -> str:
    if START_MARKER not in text or END_MARKER not in text:
        raise SystemExit(f"spawn template markers not found in {DOC_PATH}")
    before, rest = text.split(START_MARKER, 1)
    _, after = rest.split(END_MARKER, 1)
    return f"{before}{START_MARKER}\n{replacement}{END_MARKER}{after}"


def _render_table() -> str:
    _repo_import()
    from crimson.spawn_templates import SPAWN_TEMPLATES  # noqa: PLC0415

    lines = [
        "Generated by `uv run python scripts/gen_spawn_templates.py`.",
        "",
        "| Spawn id (template_id) | Type id | Creature | Flags (creature_flags) | Anim note |",
        "| --- | --- | --- | --- | --- |",
    ]
    for entry in sorted(SPAWN_TEMPLATES, key=lambda t: t.spawn_id):
        type_id = "" if entry.type_id is None else str(int(entry.type_id))
        creature = "" if entry.creature is None else entry.creature
        anim_note = "" if entry.anim_note is None else entry.anim_note
        lines.append(
            f"| `0x{entry.spawn_id:x}` | `{type_id}` | `{creature}` | `{_format_flags(entry.flags)}` | {anim_note} |"
        )
    lines.append("")
    return "\n".join(lines)


def main() -> None:
    doc_text = DOC_PATH.read_text(encoding="utf-8")
    new_block = _render_table()
    DOC_PATH.write_text(_replace_block(doc_text, new_block), encoding="utf-8")


if __name__ == "__main__":
    main()

