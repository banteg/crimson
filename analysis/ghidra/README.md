# Ghidra analysis

This directory holds Ghidra artifacts and supporting files we keep under version
control.

Layout:

- `raw/` — raw Ghidra exports (treat as read-only).
- `derived/` — outputs generated by our scripts from `raw/`.
- `scripts/` — custom Ghidra scripts.
- `maps/` — name/data maps and WinAPI GDT.

External inputs:

- `third_party/headers/` — header pack for type recovery.
- `analysis/ghidra/projects/` — kept headless projects (gitignored).

## Regenerating

1. Re-run Ghidra analysis with headers in `third_party/headers/` added to the
   C parser include paths. We use `analysis/ghidra/scripts/ImportThirdPartyHeaders.java`
   to parse codec headers before exporting:

   ```bash
   ./.codex/skills/ghidra/scripts/ghidra-analyze.sh \
     --script-path analysis/ghidra/scripts \
     -s ImportThirdPartyHeaders.java -a third_party/headers \
     -s ApplyWinapiGDT.java -a analysis/ghidra/maps/winapi_32.gdt \
     -s ApplyNameMap.java -a analysis/ghidra/maps/name_map.json \
     -s ApplyDataMap.java -a analysis/ghidra/maps/data_map.json \
     -s ExportAll.java \
     -o analysis/ghidra/raw \
     game_bins/crimsonland/1.9.93-gog/crimsonland.exe
   ```

   The header pack includes DirectX/DirectSound headers as references, but the
   import script only parses codec headers (JPEG/zlib/ogg/vorbis). The full
   `png.h` header is kept for reference but skipped in headless parsing due to
   Ghidra C parser limitations with unnamed callback parameters.

   The WinAPI .gdt is kept in `analysis/ghidra/maps/winapi_32.gdt`; override it
   via `CRIMSON_WINAPI_GDT` or the `ApplyWinapiGDT.java` script arg if needed.
   The name/data maps can be overridden via `CRIMSON_NAME_MAP` and
   `CRIMSON_DATA_MAP`.

2. For faster iterations, keep the headless project around and re-run with the
   same project name. We store these under `analysis/ghidra/projects/`:

   ```bash
   ./.codex/skills/ghidra/scripts/ghidra-analyze.sh \
     --keep-project \
     --project-dir analysis/ghidra/projects \
     --project-name crimsonland_exe \
     --script-path analysis/ghidra/scripts \
     -s ApplyNameMap.java -a analysis/ghidra/maps/name_map.json \
     -s ApplyDataMap.java -a analysis/ghidra/maps/data_map.json \
     -s ExportAll.java \
     -o analysis/ghidra/raw \
     game_bins/crimsonland/1.9.93-gog/crimsonland.exe
   ```

   Use `--project-name grim_dll` with
   `game_bins/crimsonland/1.9.93-gog/grim.dll` for Grim2D exports, and run
   the vtable helper before applying the name map so vtable entries are created
   as functions:

   ```bash
   ./.codex/skills/ghidra/scripts/ghidra-analyze.sh \
     --keep-project \
     --project-dir analysis/ghidra/projects \
     --project-name grim_dll \
     --script-path analysis/ghidra/scripts \
     -s CreateGrim2DVtableFunctions.java \
     -s ApplyNameMap.java -a analysis/ghidra/maps/name_map.json \
     -s ApplyDataMap.java -a analysis/ghidra/maps/data_map.json \
     -s ExportAll.java \
     -o analysis/ghidra/raw \
     game_bins/crimsonland/1.9.93-gog/grim.dll
   ```

3. For repeated runs on the same kept project, use `-process` with the raw
   headless analyzer so it opens the existing `grim.dll` program instead of
   re-importing it:

   ```bash
   GHIDRA_OUTPUT_DIR=analysis/ghidra/raw \
     /opt/ghidra/support/analyzeHeadless \
     analysis/ghidra/projects grim_dll \
     -process grim.dll \
     -scriptPath "/workspace/analysis/ghidra/scripts;/workspace/.codex/skills/ghidra/scripts/ghidra_scripts" \
     -postScript CreateGrim2DVtableFunctions.java \
     -postScript ApplyNameMap.java analysis/ghidra/maps/name_map.json \
     -postScript ApplyDataMap.java analysis/ghidra/maps/data_map.json \
     -postScript ExportAll.java
   ```
