# Ghidra analysis

This directory holds Ghidra artifacts and supporting files we keep under version
control.

Layout:

- `raw/` — raw Ghidra exports (treat as read-only).
- `derived/` — outputs generated by our scripts from `raw/`.
- `scripts/` — custom Ghidra scripts.
- `maps/` — name/data maps and WinAPI GDT.

External inputs:

- `third_party/headers/` — header pack for type recovery.
- `analysis/ghidra/projects/` — kept headless projects (gitignored).

## Regenerating

1. Re-run Ghidra analysis with headers in `third_party/headers/` added to the
   C parser include paths. We use `analysis/ghidra/scripts/ImportThirdPartyHeaders.java`
   to parse codec headers before exporting. The default flow is wrapped by the
   justfile shortcuts:

   ```bash
   just ghidra-exe
   ```

   For Grim2D exports:

   ```bash
   just ghidra-grim
   ```

## WSL regen + Windows sync

If the primary workspace is on Windows and Ghidra runs in WSL, use the sync
helper so outputs land in the Windows repo without leaving WSL dirty:

```bash
just ghidra-sync
```

This runs `ghidra-exe` and `ghidra-grim` in WSL, copies
`analysis/ghidra/raw/` and `analysis/ghidra/derived/` back to Windows, then
cleans the WSL outputs so `git pull` remains clean.

Override the Windows repo path if needed:

```bash
CRIMSON_WIN_REPO=/mnt/c/dev/crimson just ghidra-sync
```

   Override the game directory when needed:

   ```bash
   just game_dir=game_bins/crimsonland/1.9.93-gog ghidra-exe
   ```

The header pack includes DirectX/DirectSound headers as references, and the
import script parses codec headers (JPEG/zlib/ogg/vorbis) plus the
`png_struct_stub.h` shim used for grim.dll’s libpng 1.0.5-era layout. The full
libpng public headers (`png.h`, `pngconf.h`, `pngasmrd.h`) are kept for
reference but skipped in headless parsing due to Ghidra C parser limitations
with unnamed callback parameters.

   The WinAPI .gdt is kept in `analysis/ghidra/maps/winapi_32.gdt`; override it
   via `CRIMSON_WINAPI_GDT` or the `ApplyWinapiGDT.java` script arg if needed.
   The name/data maps can be overridden via `CRIMSON_NAME_MAP` and
   `CRIMSON_DATA_MAP`.

2. For faster iterations, keep the headless project around and re-run with the
   same project name. We store these under `analysis/ghidra/projects/` (manual
   invocation for now):

   ```bash
   ./analysis/ghidra/tooling/ghidra-analyze.sh \
     --keep-project \
     --project-dir analysis/ghidra/projects \
     --project-name crimsonland_exe \
     --script-path analysis/ghidra/scripts \
     -s CreateCreditsScreenUpdate.java \
     -s CreateCreditsSecretUpdate.java \
     -s CreateConsoleFunctions.java \
     -s ApplyNameMap.java -a analysis/ghidra/maps/name_map.json \
     -s ApplyDataMap.java -a analysis/ghidra/maps/data_map.json \
     -s ExportAll.java \
     -o analysis/ghidra/raw \
     game_bins/crimsonland/1.9.93-gog/crimsonland.exe
   ```

   Use `--project-name grim_dll` with
   `game_bins/crimsonland/1.9.93-gog/grim.dll` for Grim2D exports, and run
   the vtable helper before applying the name map so vtable entries are created
   as functions:

   ```bash
   ./analysis/ghidra/tooling/ghidra-analyze.sh \
     --keep-project \
     --project-dir analysis/ghidra/projects \
     --project-name grim_dll \
     --script-path analysis/ghidra/scripts \
     -s CreateGrim2DVtableFunctions.java \
     -s CreateConfigDialogProc.java \
     -s ApplyNameMap.java -a analysis/ghidra/maps/name_map.json \
     -s ApplyDataMap.java -a analysis/ghidra/maps/data_map.json \
     -s ExportAll.java \
     -o analysis/ghidra/raw \
     game_bins/crimsonland/1.9.93-gog/grim.dll
   ```

3. For repeated runs on the same kept project, use `-process` with the raw
   headless analyzer so it opens the existing `grim.dll` program instead of
   re-importing it:

   ```bash
   GHIDRA_OUTPUT_DIR=analysis/ghidra/raw \
     /opt/ghidra/support/analyzeHeadless \
     analysis/ghidra/projects grim_dll \
     -process grim.dll \
     -scriptPath "/workspace/analysis/ghidra/scripts;/workspace/analysis/ghidra/tooling/ghidra_scripts" \
     -postScript CreateGrim2DVtableFunctions.java \
     -postScript CreateConfigDialogProc.java \
     -postScript ApplyNameMap.java analysis/ghidra/maps/name_map.json \
     -postScript ApplyDataMap.java analysis/ghidra/maps/data_map.json \
     -postScript ExportAll.java
   ```
